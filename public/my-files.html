<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Files</title>
</head>
<body>
  <h1>ðŸ“‚ My Uploaded Files</h1>
  <p id="message" style="font-weight: bold;"></p>
  <table border="1" id="fileTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Size (KB)</th>
        <th>Uploaded</th>
        <th>Download</th>
        <th>Public URL</th>
        <th>Folder</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        alert("Copied to clipboard");
      } catch (err) {
        alert("Failed to copy");
      }
    }

    async function deleteFile(id) {
      if (!confirm("Are you sure you want to delete this file?")) return;

      const res = await fetch(`/files/${id}`, {
        method: "DELETE",
        credentials: "include"
      });

      if (res.ok) {
        location.reload();
      } else {
        alert("Failed to delete file");
      }
    }

    fetch("/me", { credentials: "include" })
      .then(res => {
        if (!res.ok) window.location.href = "/login.html";
      });

    fetch("/my-files", { credentials: "include" })
      .then(res => res.json())
      .then(data => {
        const table = document.querySelector("#fileTable tbody");

        if (!Array.isArray(data)) {
          document.getElementById("message").textContent = "Error loading files.";
          return;
        }

        data.forEach(file => {
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>${file.name}</td>
            <td>${(file.size / 1024).toFixed(2)}</td>
            <td>${new Date(file.uploadTime).toLocaleString()}</td>
            <td><a href="/files/${file.id}/download">Download</a></td>
            <td>
              ${file.url ? `
                <a href="${file.url}" target="_blank">Link</a>
                <button onclick="copyToClipboard('${file.url}')">Copy</button>
              ` : "-"}
            </td>
            <td>${file.folderId || "-"}</td>
            <td>
              <button onclick="deleteFile(${file.id})">Delete</button>
            </td>
          `;

          table.appendChild(row);
        });
      })
      .catch(() => {
        document.getElementById("message").textContent = "Failed to fetch files.";
      });
  </script>
</body>
</html>
