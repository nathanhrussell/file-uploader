<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Folders</title>
</head>
<body>
  <h1>üìÅ My Folders</h1>
  <p id="message" style="font-weight: bold;"></p>

  <form id="newFolderForm">
    <input type="text" name="name" placeholder="New folder name" required />
    <button type="submit">Create Folder</button>
  </form>

  <table border="1" id="folderTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Share</th>
        <th>Rename</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function fetchFolders() {
      const res = await fetch("/folders", { credentials: "include" });
      const data = await res.json();

      const table = document.querySelector("#folderTable tbody");
      table.innerHTML = "";

      if (!Array.isArray(data)) {
        document.getElementById("message").textContent = "Failed to load folders.";
        return;
      }

      data.forEach(folder => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${folder.name}</td>
          <td>
            <input type="number" id="days-${folder.id}" min="1" max="30" placeholder="Days" style="width: 60px;" />
            <button onclick="shareFolder(${folder.id})">Share</button>
          </td>
          <td>
            <input type="text" id="rename-${folder.id}" placeholder="New name" />
            <button onclick="renameFolder(${folder.id})">Rename</button>
          </td>
          <td>
            <button onclick="deleteFolder(${folder.id})">Delete</button>
          </td>
        `;
        table.appendChild(row);
      });
    }

    async function shareFolder(folderId) {
      const input = document.getElementById(`days-${folderId}`);
      const days = Math.min(Math.max(parseInt(input?.value) || 1, 1), 30);

      const res = await fetch(`/folders/${folderId}/share`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ days })
      });

      const data = await res.json();
      if (res.ok) {
        alert(`Share link: ${data.shareUrl}`);
      } else {
        alert(data.error || "Failed to generate share link");
      }
    }

    async function renameFolder(folderId) {
      const input = document.getElementById(`rename-${folderId}`);
      const newName = input.value.trim();
      if (!newName) return alert("New name cannot be empty");

      const res = await fetch(`/folders/${folderId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ name: newName })
      });

      if (res.ok) {
        fetchFolders();
      } else {
        alert("Failed to rename folder");
      }
    }

    async function deleteFolder(folderId) {
      if (!confirm("Are you sure you want to delete this folder?")) return;

      const res = await fetch(`/folders/${folderId}`, {
        method: "DELETE",
        credentials: "include"
      });

      if (res.ok) {
        fetchFolders();
      } else {
        alert("Failed to delete folder");
      }
    }

    document.getElementById("newFolderForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = e.target.name;
      const name = input.value.trim();

      if (!name) return;

      const res = await fetch("/folders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ name })
      });

      if (res.ok) {
        input.value = "";
        fetchFolders();
      } else {
        alert("Failed to create folder");
      }
    });

    // Auth protection
    fetch("/me", { credentials: "include" })
      .then(res => {
        if (!res.ok) {
          window.location.href = "/login.html";
        } else {
          fetchFolders();
        }
      })
      .catch(() => {
        window.location.href = "/login.html";
      });
  </script>

  <script src="/js/message.js"></script>
  <script src="/logout.js"></script>
  <script src="/js/navbar.js"></script>
</body>
</html>
